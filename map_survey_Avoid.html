<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Participatory Mapping - Dislike</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta property="og:title" content="Leaflet and Google Form Participatory Mapping" />
  <meta property="og:type" content="website" />
  <meta property="og:description" content="A map for the Mutually Fulfilling Cities Survey." />
  <!--Bootstrap for form-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />
  <!--leaflet-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
  <!--Fonts-->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900' rel='stylesheet' type='text/css'>

  <script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
 <style>
  * {
    font-family: 'open sans', sans-serif;
    box-sizing: border-box;
  }
  
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }
  
  .map {
    height: 100%;
  }
  
  #map { 
    position: absolute;
    top: 56px; /* Header Height */
    bottom: 0px;
    width: 100%;
  }
  
  /* Desaturate only the basemap tiles */
  #map .leaflet-tile-pane {
    filter: saturate(50%) contrast(0.9);
  }

  .leaflet-popup-content {
    font-size: 14px;
  }
  
  .container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    padding: 8px 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  h3 {
    color: #000000 !important;
    margin: 0;
    font-size: 18px;
    line-height: 1.3;
  }

  #pin_menu {
    max-width: 200px;
    position: absolute;
    top: 66px;
    right: 10px;
    background-color: white;
    padding: 6px 8px; 
    font: 14px/16px "open sans"; 
    background: rgba(255,255,255,0.95); 
    box-shadow: 0 0 15px rgba(0,0,0,0.2); 
    border-radius: 5px;
    z-index: 999;
  }
  
  .btn {
    cursor: pointer;
    padding: 8px;
    margin-bottom: 5px !important;
    margin-top: 5px !important;
    margin-left: auto;
    margin-right: auto;
    font-size: 14px;
    display: block;
    width: 100%;
    border: none;
    border-radius: 3px;
  }

  #instructions {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    font-family: 'open sans', sans-serif;
    padding: 15px;
    background: white;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    border-radius: 5px;
    font-size: 15px;
    z-index: 10000;
    display: block;
    color: #000000 !important;
  }
  
  #theX {
    cursor: pointer;
    position: absolute;
    top: 5px;
    right: 10px;
    font-size: 24px;
  }
  
  #theOK {
    max-width: 150px;
    margin: 10px auto 0;
  }

  #two {
    background: url('./icons/avoid2.png') #f766d0;
    background-position: 5px center;
    background-repeat: no-repeat;
    background-size: 35px 26px;
    padding-left: 45px;
    text-align: left;
  }
  
  #two:hover {
    background: url('./icons/avoid2.png') #f766d0;
    background-position: 5px center;
    background-repeat: no-repeat;
    background-size: 35px 26px;
    padding-left: 45px;
  }
  
  /* Style for text input in popup */
  .reason-input {
    width: 100%;
    padding: 8px;
    margin: 10px 0;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 14px;
  }
  
  .popup-label {
    display: block;
    margin-top: 5px;
    font-weight: bold;
    color: #00698E;
    font-size: 14px;
  }
  
  /* Status indicator */
  #statusIndicator {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: #1f7a53;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    font-size: 14px;
    z-index: 10001;
    display: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
  }

  hr {
    margin: 8px 0;
    border: none;
    border-top: 1px solid #ddd;
  }

  /* ============================================
     MOBILE RESPONSIVE STYLES
     ============================================ */
  
  @media only screen and (max-width: 768px) {
    
    /* Smaller header on mobile */
    .container {
      padding: 5px 8px;
    }
    
    h3 {
      font-size: 14px;
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: clip !important;
    }
    
    /* Adjust map top position for smaller header */
    #map {
      top: 45px;
    }
    
    /* Pin menu adjustments for mobile */
    #pin_menu {
      max-width: 140px;
      top: 50px;
      right: 5px;
      padding: 5px 6px;
      font-size: 12px;
    }
    
    .btn {
      padding: 6px;
      font-size: 12px;
      margin-bottom: 3px !important;
      margin-top: 3px !important;
    }
    
    #two {
      background-size: 28px 21px;
      padding-left: 35px;
    }
    
    #two:hover {
      background-size: 28px 21px;
      padding-left: 35px;
    }
    
    /* Instructions box for mobile */
    #instructions {
      max-width: 95%;
      max-height: 85vh;
      padding: 12px;
      font-size: 14px;
    }
    
    #instructions p {
      font-size: 14px;
      margin-bottom: 10px !important;
    }
    
    #theOK {
      width: 100%;
      max-width: none;
    }
    
    /* Larger touch targets for mobile */
    .leaflet-popup-content {
      font-size: 15px;
    }
    
    .reason-input {
      font-size: 16px; /* Prevents auto-zoom on iOS */
      padding: 10px;
    }
    
    .popup-label {
      font-size: 15px;
    }
    
    /* Status indicator positioning */
    #statusIndicator {
      top: 50px;
      font-size: 13px;
      padding: 6px 12px;
    }
    
    /* Make popups fit better on small screens */
    .leaflet-popup {
      max-width: 85vw !important;
    }
    
    hr {
      margin: 6px 0;
    }
  }
  
  /* Extra small phones */
  @media only screen and (max-width: 480px) {
    
    h3 {
      font-size: 12px;
    }
    
    #map {
      top: 40px;
    }
    
    #pin_menu {
      max-width: 120px;
      top: 45px;
      padding: 4px 5px;
      font-size: 11px;
    }
    
    .btn {
      padding: 5px;
      font-size: 11px;
    }
    
    #two {
      background-size: 24px 18px;
      padding-left: 30px;
    }
    
    #two:hover {
      background-size: 24px 18px;
      padding-left: 30px;
    }
    
    #instructions {
      padding: 10px;
      font-size: 13px;
    }
    
    #instructions p {
      font-size: 13px;
    }
  }
  
  /* Landscape orientation on mobile */
  @media only screen and (max-height: 500px) and (orientation: landscape) {
    
    .container {
      padding: 3px 8px;
    }
    
    h3 {
      font-size: 12px;
    }
    
    #map {
      top: 35px;
    }
    
    #pin_menu {
      top: 40px;
      max-width: 100px;
      padding: 3px 4px;
    }
    
    .btn {
      padding: 4px;
      font-size: 10px;
    }
    
    #instructions {
      max-height: 90vh;
      padding: 10px;
      font-size: 12px;
    }
  }
  
  /* Improve touch interactions */
  @media (hover: none) and (pointer: coarse) {
    /* This targets touch devices */
    
    .btn {
      min-height: 44px; /* Apple's recommended touch target */
      padding: 10px;
    }
    
    #theX {
      font-size: 28px;
      padding: 5px;
    }
    
    /* Larger tap target for leaflet controls */
    .leaflet-control-zoom a {
      width: 40px !important;
      height: 40px !important;
      line-height: 40px !important;
      font-size: 20px !important;
    }
  }
</style>
</head>

<body>
  <div class="container text-center">
    <h3 style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">WHERE DO YOU DISLIKE GOING WITH YOUR KIDS IN THE BOSTON AREA?</h3>
  </div>
  
  <!-- Status indicator -->
  <div id="statusIndicator">✓ Saved</div>
  
  <div class="map">
    <div id="map"></div>
  </div>
  
  <div id="pin_menu">
    <a id="destroy" onclick="destroy_all()"
       class="btn center-block"
       style="background-color:#00698E; color:#fff;">
       Clear all markers
    </a>
  </div>

  <div id="instructions">
    <strong>TELL ME ABOUT THE PLACES YOU DISLIKE GOING WITH YOUR KIDS.</strong><br><br>
    <div style="text-align:left; margin:10px 0; padding-left:0;">
      <p style="margin-bottom:14px;">Click on the places that you go with your kids that make you feel <strong>drained, tired, or bored<strong> (select as many as you want).</p>
      <p style="margin-bottom:14px;">Your markers are <strong>automatically saved</strong> as you place them. If you delete them, the information will be removed from the survey.</p>
      <p style="margin-bottom:14px;">Click on markers to add comments, delete them, or drag to move them.</p>
      <p style="margin-bottom:0px; font-style:italic; color:#666;">Once finished, just click "Next" in the survey.</p>
    </div>
    <div style="margin-top:6px;">
    <a class="btn btn-success center-block theX" id="theOK" style="background-color:#1f7a53; color:#fff; margin-top:6px; padding-top:6px; padding-bottom:6px;">OK</a>    </div>
    <div id="theX" class="theX"><b>×</b></div>
  </div>

  <script>
  var map = L.map('map'); //Initialize the map

  // Add basemap
  var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    minZoom: 4,
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
  
  map.setView([42.37083185, -71.106332908], 16);

  // CRITICAL: Force map to recalculate size in iframe
  setTimeout(function() {
    map.invalidateSize();
    console.log('Map size invalidated - attempt 1');
  }, 100);

  setTimeout(function() {
    map.invalidateSize();
    console.log('Map size invalidated - attempt 2');
  }, 500);

  setTimeout(function() {
    map.invalidateSize();
    console.log('Map size invalidated - attempt 3');
  }, 1500);

  // Invalidate on window resize
  window.addEventListener('resize', function() {
    map.invalidateSize();
  });

  var marker, lat, lng;

  // Markers array and counter
  markers = []
  markerComments = {}
  i = -1
  
  current_marker_type = "two"
  
  // Custom map marker
  var dislike = L.icon({
    name: 'Dislike',
    iconUrl: 'icons/avoid2.png',
    iconSize: [60, 40], 
    iconAnchor: [30, 20],
    popupAnchor: [0, -20] 
  });

  function iconpicker(type_number){
    if(type_number == "two"){
      return dislike
    }
  }

  // SEND DATA TO QUALTRICS
  function sendDataToQualtrics() {
    var coordinates = [];
    var comments = [];
    
    for(_i = 0; _i < markers.length; _i++){
      if(markers[_i]) {
        var latlng = markers[_i].getLatLng();
        coordinates.push({
          lat: latlng.lat,
          lng: latlng.lng,
          id: _i
        });
        
        var comment = markerComments[_i] || "";
        comments.push({
          id: _i,
          comment: comment
        });
      }
    }
    
    window.parent.postMessage({
      type: 'dislike_map_data',
      coordinates: JSON.stringify(coordinates),
      comments: JSON.stringify(comments),
      marker_count: coordinates.length,
      timestamp: new Date().toISOString()
    }, '*');
    
    console.log('✓ Data sent to Qualtrics:', {
      markers: coordinates.length,
      coordinates: coordinates,
      comments: comments
    });
    
    showSavedIndicator();
  }

  function showSavedIndicator() {
    var indicator = document.getElementById('statusIndicator');
    indicator.style.display = 'block';
    setTimeout(function() {
      indicator.style.display = 'none';
    }, 1500);
  }

  function destroy_self(this_marker_id){
    map.removeLayer(markers[this_marker_id])
    delete markerComments[this_marker_id];
    markers[this_marker_id] = null;
    sendDataToQualtrics();
  }

  function destroy_all(){
    for(_i = 0; _i < markers.length; _i++){
      if(markers[_i]) {
        map.removeLayer(markers[_i])
      }
    }
    markers = [];
    markerComments = {};
    sendDataToQualtrics();
  }

  function saveComment(marker_id) {
    var commentText = document.getElementById('comment_' + marker_id).value;
    markerComments[marker_id] = commentText;
    console.log('Saved comment for marker ' + marker_id + ': ' + commentText);
    sendDataToQualtrics();
  }

  // Collect data when map is clicked
  function collectData(e) {
    i += 1
    this_marker_id = i
    lat = e.latlng.lat;
    lng = e.latlng.lng;
    type = current_marker_type

    console.log('Marker placed at:', lat, lng); // Debug log

    var popup_text = 
      '<div style="min-width:200px;">' +
      '<label class="popup-label">Tell me why you dislike it:</label>' +
      '<textarea id="comment_' + this_marker_id + '" class="reason-input" rows="3" placeholder="Type your reason here..."></textarea>' +
      '<button class="btn btn-sm center-block" style="background-color:#1f7a53; color:#fff; margin-top:5px;" onclick="saveComment(' + this_marker_id + ')">Save Comment</button>' +
      '<hr style="margin:10px 0;">' +
      '<button class="btn btn-sm center-block" style="background-color:#f9a34d; color:#fff;" onclick="destroy_self(' + this_marker_id + ')">Delete Marker</button>' +
      '</div>';

    markers[i] = L.marker(e.latlng, {
      draggable: true,
      icon: iconpicker(type),
      type_of_marker: type,
      this_marker_id: this_marker_id
    }).addTo(map)
    .bindPopup(popup_text, {maxWidth:300})
    .openPopup();

    sendDataToQualtrics();

    markers[i].on('dragend', function(event) {
      sendDataToQualtrics();
    });
  }

  // Listen for clicks
  map.on('click', function(e) {
    console.log('Map clicked!', e.latlng); // Debug log
    collectData(e);
  });

  // Close instructions and ensure map is clickable
  $(".theX").click(function(){
    $("#instructions").hide();
    setTimeout(function() {
      map.invalidateSize();
      console.log('Map invalidated after closing instructions');
    }, 100);
  });

  // Debug: Log when map is ready
  console.log('Map initialized and ready for clicks');
</script>

</body>

</html>

